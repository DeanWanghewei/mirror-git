# æ•°æ®æ¢å¤æŒ‡å—

## é—®é¢˜è¯´æ˜

å¦‚æœæ‚¨åœ¨å‡çº§åå‘ç°æ•°æ®ä¸¢å¤±ï¼Œè¿™æ˜¯å› ä¸ºæ•°æ®åº“æ–‡ä»¶åå‘ç”Ÿäº†å˜åŒ–ï¼š

- **æ—§ç‰ˆæœ¬**: `data/sync.db`
- **æŸä¸ªç‰ˆæœ¬**: `data/mirror_sync.db`
- **å½“å‰ç‰ˆæœ¬**: `data/sync.db`ï¼ˆå·²ä¿®å¤ï¼Œå‘åå…¼å®¹ï¼‰

## å¿«é€Ÿæ¢å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: ä½¿ç”¨æ¢å¤è„šæœ¬ï¼ˆæ¨èï¼‰

è¿è¡Œè‡ªåŠ¨æ¢å¤è„šæœ¬ï¼š

```bash
python scripts/restore_database.py
```

è„šæœ¬ä¼šï¼š
1. è‡ªåŠ¨æ£€æµ‹æ–°æ—§æ•°æ®åº“
2. æ¯”è¾ƒæ•°æ®åº“å¤§å°
3. æä¾›æ¢å¤é€‰é¡¹
4. è‡ªåŠ¨å¤‡ä»½å’Œè¿ç§»

### æ–¹æ¡ˆ 2: æ‰‹åŠ¨æ¢å¤

#### æ­¥éª¤ 1: æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶

```bash
ls -lh data/*.db
```

æ‚¨å¯èƒ½çœ‹åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š
- `data/sync.db` - æ—§æ•°æ®åº“ï¼ˆæœ‰æ•°æ®ï¼‰
- `data/mirror_sync.db` - æ–°æ•°æ®åº“ï¼ˆå¯èƒ½ä¸ºç©ºï¼‰

#### æ­¥éª¤ 2: ç¡®è®¤å“ªä¸ªæ•°æ®åº“æœ‰æ•°æ®

æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼Œæ›´å¤§çš„é€šå¸¸åŒ…å«æ•°æ®ï¼š

```bash
# æ—§æ•°æ®åº“
ls -lh data/sync.db

# æ–°æ•°æ®åº“
ls -lh data/mirror_sync.db
```

#### æ­¥éª¤ 3: æ¢å¤æ•°æ®

**é€‰é¡¹ A: åˆ é™¤æ–°æ•°æ®åº“ï¼Œä½¿ç”¨æ—§æ•°æ®åº“**

```bash
# å¤‡ä»½æ–°æ•°æ®åº“ï¼ˆå¦‚æœéœ€è¦ï¼‰
cp data/mirror_sync.db data/mirror_sync.db.backup

# åˆ é™¤æ–°æ•°æ®åº“
rm data/mirror_sync.db

# é‡å¯åº”ç”¨
docker-compose restart app
# æˆ–
python run.py
```

ç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨ `data/sync.db`ï¼ˆæ—§æ•°æ®åº“ï¼‰ï¼Œæ‚¨çš„æ•°æ®ä¼šæ¢å¤ã€‚

**é€‰é¡¹ B: ä½¿ç”¨æ–°æ•°æ®åº“ï¼ˆå¦‚æœæ–°æ•°æ®åº“æœ‰æ•°æ®ï¼‰**

```bash
# å¤‡ä»½æ—§æ•°æ®åº“
cp data/sync.db data/sync.db.backup

# åˆ é™¤æ—§æ•°æ®åº“
rm data/sync.db

# è®¾ç½®ç¯å¢ƒå˜é‡ä½¿ç”¨æ–°æ•°æ®åº“ï¼ˆæ³¨æ„ï¼š4ä¸ªæ–œæ è¡¨ç¤ºç»å¯¹è·¯å¾„ï¼‰
export DATABASE_URL=sqlite:////app/data/mirror_sync.db

# é‡å¯åº”ç”¨
docker-compose restart app
```

æˆ–åœ¨ `.env` æ–‡ä»¶ä¸­æ·»åŠ ï¼š
```env
# ä½¿ç”¨ç»å¯¹è·¯å¾„ï¼ˆ4ä¸ªæ–œæ ï¼‰
DATABASE_URL=sqlite:////app/data/mirror_sync.db
```

### æ–¹æ¡ˆ 3: Docker ç”¨æˆ·

å¦‚æœä½¿ç”¨ Dockerï¼š

```bash
# 1. åœæ­¢å®¹å™¨
docker-compose down

# 2. æ£€æŸ¥å®¿ä¸»æœºçš„ data ç›®å½•
ls -lh ./data/

# 3. å¦‚æœçœ‹åˆ° sync.dbï¼Œç¡®ä¿å®ƒè¢«ä¿ç•™
# å¦‚æœæœ‰ mirror_sync.db ä¸”è¾ƒå°ï¼Œå¯ä»¥åˆ é™¤å®ƒ
rm ./data/mirror_sync.db

# 4. é‡æ–°å¯åŠ¨
docker-compose up -d

# 5. æ£€æŸ¥æ—¥å¿—
docker-compose logs -f app
```

## é¢„é˜²æªæ–½

### 1. æ•°æ®åº“ä½ç½®è¯´æ˜

**é»˜è®¤æ•°æ®åº“ä½ç½®**ï¼š
- Docker: `/app/data/sync.db` (æ˜ å°„åˆ°å®¿ä¸»æœº `./data/sync.db`)
- æœ¬åœ°: `./data/sync.db`

**volume æŒ‚è½½ï¼ˆdocker-compose.ymlï¼‰**ï¼š
```yaml
volumes:
  - ./data:/app/data  # æ•°æ®åº“å’Œä»“åº“
  - ./logs:/app/logs  # æ—¥å¿—
```

### 2. æ•°æ®å¤‡ä»½

**å®šæœŸå¤‡ä»½æ•°æ®åº“**ï¼š

```bash
# æ‰‹åŠ¨å¤‡ä»½
cp data/sync.db data/sync.db.backup.$(date +%Y%m%d_%H%M%S)

# æˆ–åˆ›å»ºå®šæ—¶ä»»åŠ¡
# crontab -e
0 2 * * * cp /path/to/mirror-git/data/sync.db /path/to/backup/sync.db.$(date +\%Y\%m\%d)
```

**å¤‡ä»½æ•´ä¸ª data ç›®å½•**ï¼š

```bash
# å‹ç¼©å¤‡ä»½
tar -czf backup_$(date +%Y%m%d).tar.gz data/

# æ¢å¤
tar -xzf backup_20231222.tar.gz
```

### 3. å‡çº§å‰æ£€æŸ¥æ¸…å•

å‡çº§æ–°ç‰ˆæœ¬å‰ï¼š

```bash
# 1. å¤‡ä»½æ•°æ®
cp -r data data.backup

# 2. è®°å½•å½“å‰æ•°æ®åº“è·¯å¾„
echo $DATABASE_URL

# 3. æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
ls -lh data/*.db

# 4. å‡çº§ï¼ˆæ‹‰å–æ–°ä»£ç æˆ–é‡æ–°æ„å»ºï¼‰
git pull
docker-compose build

# 5. å¯åŠ¨å‰ç¡®è®¤ volume æŒ‚è½½æ­£ç¡®
docker-compose config | grep volumes -A 5

# 6. å¯åŠ¨
docker-compose up -d
```

## ç¯å¢ƒå˜é‡é…ç½®

ç¡®ä¿ `.env` æˆ– `docker-compose.yml` ä¸­æ­£ç¡®é…ç½®ï¼š

```env
# SQLiteï¼ˆé»˜è®¤ï¼Œæ¨èï¼‰
# ğŸ’¡ æ ¼å¼è¯´æ˜ï¼š
#   sqlite:////app/data/xxx.db  (4ä¸ªæ–œæ  = ç»å¯¹è·¯å¾„ /app/data/xxx.db) âœ… æ¨è
#   sqlite:///data/xxx.db       (3ä¸ªæ–œæ  = ç›¸å¯¹è·¯å¾„ï¼Œå·¥ä½œç›®å½• /app + data/xxx.db = /app/data/xxx.db)
DATABASE_URL=sqlite:////app/data/sync.db

# æˆ–ä½¿ç”¨ MySQL
DATABASE_URL=mysql+pymysql://mirror_user:mirror123456@mysql:3306/mirror_git?charset=utf8mb4
```

## å¸¸è§é—®é¢˜

### Q: æ•°æ®åº“æ–‡ä»¶åœ¨å“ªé‡Œï¼Ÿ

**Docker ç¯å¢ƒ**ï¼š
- å®¹å™¨å†…ï¼š`/app/data/sync.db`
- å®¿ä¸»æœºï¼š`./data/sync.db`ï¼ˆç›¸å¯¹äº docker-compose.yml æ‰€åœ¨ç›®å½•ï¼‰

**æœ¬åœ°ç¯å¢ƒ**ï¼š
- `./data/sync.db`ï¼ˆç›¸å¯¹äºé¡¹ç›®æ ¹ç›®å½•ï¼‰

### Q: å¦‚ä½•éªŒè¯æ•°æ®æ˜¯å¦æ¢å¤ï¼Ÿ

è®¿é—® Web UIï¼š
```bash
# æ‰“å¼€æµè§ˆå™¨
http://localhost:8000
```

æ£€æŸ¥ï¼š
- ä»“åº“åˆ—è¡¨æ˜¯å¦æ˜¾ç¤ºä¹‹å‰æ·»åŠ çš„ä»“åº“
- åŒæ­¥å†å²æ˜¯å¦å­˜åœ¨
- ç»Ÿè®¡æ•°æ®æ˜¯å¦æ­£ç¡®

### Q: æ¢å¤åä»“åº“å¤§å°æ˜¾ç¤º 0 æ€ä¹ˆåŠï¼Ÿ

é‡æ–°åŒæ­¥ä»»æ„ä¸€ä¸ªä»“åº“ï¼Œå¤§å°ä¼šè‡ªåŠ¨æ›´æ–°ï¼š

1. è®¿é—® Web UI çš„"ä»“åº“ç®¡ç†"
2. ç‚¹å‡»ä»»æ„ä»“åº“çš„"åŒæ­¥"æŒ‰é’®
3. åŒæ­¥å®Œæˆåå¤§å°ä¼šè‡ªåŠ¨è®¡ç®—å¹¶æ˜¾ç¤º

### Q: å¦‚ä½•åœ¨ Docker ä¸­ç›´æ¥æŸ¥çœ‹æ•°æ®åº“ï¼Ÿ

```bash
# è¿›å…¥å®¹å™¨
docker-compose exec app bash

# æŸ¥çœ‹æ•°æ®åº“
sqlite3 /app/data/sync.db

# SQLite å‘½ä»¤
.tables           # æŸ¥çœ‹æ‰€æœ‰è¡¨
.schema           # æŸ¥çœ‹è¡¨ç»“æ„
SELECT * FROM repositories;  # æŸ¥çœ‹ä»“åº“
.quit             # é€€å‡º
```

## è”ç³»æ”¯æŒ

å¦‚æœä»¥ä¸Šæ–¹æ³•éƒ½æ— æ³•æ¢å¤æ•°æ®ï¼Œè¯·ï¼š

1. ä¿ç•™ `data` ç›®å½•çš„å¤‡ä»½
2. è®°å½•é”™è¯¯ä¿¡æ¯
3. æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
   - ä½¿ç”¨çš„ç‰ˆæœ¬
   - éƒ¨ç½²æ–¹å¼ï¼ˆDocker/æœ¬åœ°ï¼‰
   - `ls -lh data/` çš„è¾“å‡º
   - åº”ç”¨æ—¥å¿—

---

**é‡è¦æç¤º**ï¼š
- âœ… å§‹ç»ˆå¤‡ä»½ `data` ç›®å½•
- âœ… å‡çº§å‰æ£€æŸ¥æ•°æ®åº“æ–‡ä»¶
- âœ… ä½¿ç”¨ volume æŒ‚è½½ç¡®ä¿æ•°æ®æŒä¹…åŒ–
- âœ… å®šæœŸå¤‡ä»½æ•°æ®åº“æ–‡ä»¶
